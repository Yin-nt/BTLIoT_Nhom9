# BTLIoT Smart Locker System - Luá»“ng Hoáº¡t Äá»™ng Chi Tiáº¿t

## 1. Tá»”NG QUAN Há»† THá»NG (3 Táº§ng)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Táº¦NG á»¨NG Dá»¤NG (Application Layer)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   React.js   â”‚  Next.js API â”‚  WebSocket   â”‚  MySQL DB    â”‚  â”‚
â”‚  â”‚  Frontend    â”‚   Backend    â”‚  Real-time   â”‚  (LÆ°u trá»¯)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†• HTTP/JSON                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Táº¦NG Máº NG (Network Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Wi-Fi (TCP)  â”‚ MQTT (HiveMQ)     â”‚ WebSocket (Real-time)   â”‚  â”‚
â”‚  â”‚ 802.11 b/g/n â”‚ Pub/Sub Protocol â”‚ Event Streaming (SSE)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†•                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             Táº¦NG Cáº¢NH NHáº¬N (Perception Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ESP32-CAM    â”‚ Camera       â”‚ PIR Sensor   â”‚ Servo Motor  â”‚  â”‚
â”‚  â”‚ (Vi Ä‘iá»u khiá»ƒn)(2MP Image)  â”‚ (Motion)     â”‚ (Lock Control)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 2. LUá»’NG ÄÄ‚NG NHáº¬P (Login Flow)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚
â”‚ (React.js)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ User nháº­p email + password
       â”‚
       â”œâ”€ Click "Sign In"
       â”‚
       â”œâ”€ POST /api/auth/login
       â”‚  {
       â”‚    "email": "user@example.com",
       â”‚    "password": "Password123"
       â”‚  }
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend (Node.js + Next.js)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  app/api/auth/login/route.ts         â”‚   â”‚
â”‚  â”‚  1. Extract email & password         â”‚   â”‚
â”‚  â”‚  2. Query DB: SELECT * FROM users    â”‚   â”‚
â”‚  â”‚  3. Verify password (bcrypt)         â”‚   â”‚
â”‚  â”‚  4. Generate JWT token               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  lib/auth.ts                         â”‚   â”‚
â”‚  â”‚  - hashPassword(password)            â”‚   â”‚
â”‚  â”‚  - verifyPassword(password, hash)    â”‚   â”‚
â”‚  â”‚  - generateToken(userId, email)      â”‚   â”‚
â”‚  â”‚  - verifyToken(token)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Database (MySQL)                    â”‚   â”‚
â”‚  â”‚  SELECT id, email, password_hash     â”‚   â”‚
â”‚  â”‚         full_name, role              â”‚   â”‚
â”‚  â”‚  FROM users WHERE email = ?          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€ Return JSON:
               â”‚  {
               â”‚    "user": {
               â”‚      "id": 1,
               â”‚      "email": "user@example.com",
               â”‚      "fullName": "John Doe",
               â”‚      "role": "user"
               â”‚    },
               â”‚    "token": "eyJhbGciOiJIUzI1NiIs..."
               â”‚  }
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Browser   â”‚
        â”‚ (React.js)  â”‚
        â”‚ - Save token to localStorage
        â”‚ - Save user info
        â”‚ - Redirect to /dashboard
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 3. LUá»’NG Má» KHÃ“A (Unlock Flow) - 3 CÃ¡ch

### 3A. Má»Ÿ KhÃ³a Tá»« Xa (Remote Unlock)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Web Dashboard                             â”‚
â”‚         (Components â†’ device-control-card.tsx)                   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Device Card:                                             â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚ Locker #1                    Battery: 85%          â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ Location: Room 101           Status: ONLINE        â”‚ â”‚    â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ â”‚     [ğŸ”“ UNLOCK DEVICE]  [Refresh]           â”‚ â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  User clicks "UNLOCK DEVICE" button                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ POST /api/devices/[id]/unlock
             â”‚  Header: Authorization: Bearer {token}
             â”‚  Body: { "accessMethod": "remote" }
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend API (Node.js)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ app/api/devices/[id]/unlock/route.ts                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 1. Extract JWT token from Authorization header         â”‚   â”‚
â”‚  â”‚    token = "eyJhbGciOiJIUzI1NiIs..."                   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 2. Verify token (lib/auth.ts):                         â”‚   â”‚
â”‚  â”‚    decoded = jwt.verify(token, JWT_SECRET)            â”‚   â”‚
â”‚  â”‚    â†’ { userId: 1, email: "user@example.com", ... }    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 3. Check user access permission:                       â”‚   â”‚
â”‚  â”‚    SELECT * FROM user_device_access                    â”‚   â”‚
â”‚  â”‚    WHERE user_id = 1 AND device_id = 5                 â”‚   â”‚
â”‚  â”‚    If no permission â†’ Return 403 Forbidden             â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 4. Log access attempt:                                 â”‚   â”‚
â”‚  â”‚    INSERT INTO access_logs (                           â”‚   â”‚
â”‚  â”‚      device_id, user_id, access_method, status         â”‚   â”‚
â”‚  â”‚    ) VALUES (5, 1, 'remote', 'success')                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 5. Send MQTT command to ESP32-CAM:                     â”‚   â”‚
â”‚  â”‚    mqtt.publish(                                        â”‚   â”‚
â”‚  â”‚      'device/5/unlock',                                â”‚   â”‚
â”‚  â”‚      { "unlock": true, "timestamp": 1699... }          â”‚   â”‚
â”‚  â”‚    )                                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 6. Return success response:                            â”‚   â”‚
â”‚  â”‚    { "message": "Device unlock command sent" }         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
         (Wi-Fi + MQTT)
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         HiveMQ Cloud (MQTT Broker)                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Broker URL: mqtt://broker.hivemq.com:1883    â”‚   â”‚
    â”‚  â”‚ Username: (if required)                      â”‚   â”‚
    â”‚  â”‚ Password: (if required)                      â”‚   â”‚
    â”‚  â”‚                                              â”‚   â”‚
    â”‚  â”‚ Topic: device/5/unlock                       â”‚   â”‚
    â”‚  â”‚ Message: { "unlock": true, ... }            â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (Subscribe to device/5/unlock)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         ESP32-CAM (Firmware)                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 1. Receive MQTT message                      â”‚  â”‚
    â”‚  â”‚ 2. Parse payload: { "unlock": true }        â”‚  â”‚
    â”‚  â”‚ 3. Send PWM signal to Servo Motor:          â”‚  â”‚
    â”‚  â”‚    digitalWrite(SERVO_PIN, HIGH)            â”‚  â”‚
    â”‚  â”‚    digitalWrite(SERVO_PIN, LOW) after 1s    â”‚  â”‚
    â”‚  â”‚ 4. Servo rotates 90Â° â†’ Lock opens           â”‚  â”‚
    â”‚  â”‚ 5. Wait 5 seconds â†’ Servo rotates back      â”‚  â”‚
    â”‚  â”‚ 6. Lock closes automatically                â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Optional: Send status update back to server
             â”‚  mqtt.publish('device/5/status', { "locked": true })
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Servo Motor (SG90)                                 â”‚
    â”‚  - Torque: 1.25 kgâ‹…cm                              â”‚
    â”‚  - Speed: 0.1s per 60Â°                             â”‚
    â”‚  - Angle: 0Â° - 180Â°                                â”‚
    â”‚                                                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚  â”‚ PWM Signal (5V)                     â”‚            â”‚
    â”‚  â”‚ â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€          â”‚            â”‚
    â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚            â”‚
    â”‚  â”‚ Duty Cycle 50% â†’ 90Â° rotation      â”‚            â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
    â”‚                                                     â”‚
    â”‚  Result: Chá»‘t tá»§ má»Ÿ ra                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Web Browser â”‚
        â”‚ (React.js)   â”‚
        â”‚ Receive 200 OK response
        â”‚ Show success toast:
        â”‚ "Tá»§ Ä‘Ã£ Ä‘Æ°á»£c má»Ÿ thÃ nh cÃ´ng!"
        â”‚ Refresh device status
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

### 3B. Má»Ÿ KhÃ³a Báº±ng KhuÃ´n Máº·t (Face Recognition)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESP32-CAM (Perception Layer)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. PIR Sensor detects motion                            â”‚  â”‚
â”‚  â”‚    â†’ Trigger ESP32 to capture image                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ 2. Camera captures image (JPEG, 2MP)                    â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚    â”‚  Camera Frame                 â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â”‚  ~~~~ User Face ~~~~   â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â”‚                        â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â”‚  KhuÃ´n máº·t ngÆ°á»i dÃ¹ng  â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â”‚                        â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                     â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ 3. Compress image (JPEG < 50KB)                        â”‚  â”‚
â”‚  â”‚    Original: 200KB â†’ Compressed: 45KB                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ 4. Encode to Base64:                                    â”‚  â”‚
â”‚  â”‚    /9j/4AAQSkZJRgABAgEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQ...  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ 5. Send HTTP POST to server:                           â”‚  â”‚
â”‚  â”‚    POST /api/face/recognize                            â”‚  â”‚
â”‚  â”‚    Content-Type: application/json                      â”‚  â”‚
â”‚  â”‚    {                                                    â”‚  â”‚
â”‚  â”‚      "imageBase64": "/9j/4AAQSkZJRg...",             â”‚  â”‚
â”‚  â”‚      "deviceId": "5",                                 â”‚  â”‚
â”‚  â”‚      "timestamp": 1699...                             â”‚  â”‚
â”‚  â”‚    }                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ HTTP POST (Wi-Fi)
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Backend Server (Node.js + AI Model)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ app/api/face/recognize/route.ts                         â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ BÆ¯á»šC 1: Nháº­n diá»‡n khuÃ´n máº·t (Face Detection)           â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Input: Image JPEG (Base64)                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Model: MT-CNN (Multi-Task CNN)                     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Process:                                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  1. Decode Base64 â†’ Image                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  2. P-Net: Scan for face regions                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  3. R-Net: Refine bounding boxes                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  4. O-Net: Get face landmarks                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Output:                                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ {                                                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "detected": true,                               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "confidence": 0.98,                             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "bbox": [150, 100, 350, 400]                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ }                                                  â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ BÆ¯á»šC 2: Kiá»ƒm tra giáº£ máº¡o (Spoofing Detection)        â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Model: CNN Classification (Real vs Fake)            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Features analyzed:                                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Skin texture (káº¿t cáº¥u da)                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Lighting consistency (tÃ­nh nháº¥t quÃ¡n Ã¡nh sÃ¡ng)  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Frequency analysis (phÃ¢n tÃ­ch táº§n sá»‘)           â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Motion cues (dáº¥u hiá»‡u chuyá»ƒn Ä‘á»™ng)             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Output: spoofingRisk = 0.15 (< 0.7 â†’ OK)         â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ BÆ¯á»šC 3: TrÃ­ch xuáº¥t Ä‘áº·c trÆ°ng (Face Embedding)        â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Model: FaceNet (Triplet Loss)                       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Process:                                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  1. Input: Face cropped image                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  2. CNN layers: Extract features                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  3. Output layer: 128D vector (embedding)         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Output:                                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ capturedEmbedding = [                             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   0.234, -0.567, 0.891, 0.123, ..., 0.456       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ] // 128 dimensions                               â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ BÆ¯á»šC 4: So sÃ¡nh vá»›i DB (Face Matching)               â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ 1. Get device authorized users:                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    SELECT user_id FROM user_device_access          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    WHERE device_id = 5                             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    â†’ [user_1, user_2, user_3]                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 2. For each user, get registered embedding:       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    SELECT embedding_vector FROM face_embeddings   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    WHERE user_id = 1                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    registeredEmbedding = JSON.parse(...)          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 3. Calculate Euclidean distance:                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    distance = sqrt(                               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      (e1[0]-r1[0])Â² + (e1[1]-r1[1])Â² + ...       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    )                                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    = 0.45                                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 4. Convert to similarity score:                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    similarity = 1 / (1 + distance)                â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    = 1 / (1 + 0.45)                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    = 0.69 (69%)                                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 5. Compare with threshold (0.6):                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    0.69 >= 0.6 â†’ MATCH!                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Result:                                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ {                                                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "match": true,                                  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "similarity": 0.69,                             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   "userId": 1                                     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ }                                                  â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ BÆ¯á»šC 5: Káº¿t luáº­n                                        â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Match found (user_id = 1, similarity = 0.69)      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 1. Log successful access:                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    INSERT INTO access_logs (                       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      device_id: 5,                               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      user_id: 1,                                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      access_method: 'face',                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      status: 'success',                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      face_confidence: 0.98,                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      timestamp: NOW()                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    )                                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 2. Send unlock command (same as remote):         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    mqtt.publish('device/5/unlock',               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      { "unlock": true }                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    )                                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ 3. Return success response:                       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    {                                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      "success": true,                            â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      "message": "Face recognized",               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      "userId": 1,                                â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      "confidence": 0.98,                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚      "similarity": 0.69                          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚    }                                              â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ MQTT: device/5/unlock â†’ ESP32-CAM â†’ Servo opens
             â”‚
             â”œâ”€ SSE (Server-Sent Events):
             â”‚  Broadcast alert to all connected WebSocket clients:
             â”‚  "Device 5 unlocked by face recognition!"
             â”‚
             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ESP32-CAM   â”‚
        â”‚  Open lock   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  All Users   â”‚
        â”‚  Get real-time
        â”‚  notification
        â”‚  on dashboard
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

### 3C. Káº¿t Quáº£ KhÃ´ng Khá»›p (Failed Recognition)

\`\`\`
Face recognition:
  - No face detected â†’ Log failure
  - Spoofing detected â†’ Send ALERT + Log
  - Unknown face â†’ Send ALERT + Log

Flow:
  1. No match found in database
  2. INSERT INTO access_logs (status: 'unauthorized')
  3. INSERT INTO alerts (alert_type: 'unauthorized_access')
  4. Return: { "success": false, "message": "Face not recognized" }
  5. WebSocket broadcasts alert to admin dashboard
  6. Admin receives: "Unknown face detected at Device 5"
\`\`\`

---

## 4. LUá»’NG REAL-TIME ALERTS (WebSocket + SSE)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Opens Dashboard (React)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ components/alerts-panel.tsx                             â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ useEffect(() => {                                       â”‚    â”‚
â”‚  â”‚   const eventSource = new EventSource('/api/events');  â”‚    â”‚
â”‚  â”‚   eventSource.onmessage = (event) => {                 â”‚    â”‚
â”‚  â”‚     const alert = JSON.parse(event.data);              â”‚    â”‚
â”‚  â”‚     setAlerts(prev => [alert, ...prev]);               â”‚    â”‚
â”‚  â”‚   };                                                    â”‚    â”‚
â”‚  â”‚ }, [])                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Browser connects to: GET /api/events
             â”‚  (Server-Sent Events - persistent connection)
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Backend (app/api/events/route.ts)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. New browser connects                                   â”‚  â”‚
â”‚  â”‚ 2. Create ReadableStream                                 â”‚  â”‚
â”‚  â”‚ 3. Store connection for broadcasting                      â”‚  â”‚
â”‚  â”‚ 4. Listen for new events                                 â”‚  â”‚
â”‚  â”‚ 5. Push events to browser via stream:                    â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ data: {                                                 â”‚  â”‚
â”‚  â”‚   "type": "device_unlocked",                           â”‚  â”‚
â”‚  â”‚   "deviceId": 5,                                        â”‚  â”‚
â”‚  â”‚   "message": "Tá»§ #5 Ä‘Æ°á»£c má»Ÿ lÃºc 14:30:45",            â”‚  â”‚
â”‚  â”‚   "timestamp": 1699000000000                            â”‚  â”‚
â”‚  â”‚ }                                                        â”‚  â”‚
â”‚  â”‚ // 2 newlines to signal end of message                 â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ data: { next event ... }                               â”‚  â”‚
â”‚  â”‚ ...                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†‘
             â”‚ (Persistent HTTP connection, no polling)
             â”‚ Real-time data push from server to client
             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Browser UI  â”‚
        â”‚  Updates     â”‚
        â”‚  instantly   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 5. LUá»’NG MQTT & ESP32-CAM

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Backend Server (lib/mqtt.ts)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ getMqttClient():                                         â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚ â”‚ mqtt.connect(                                      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   "mqtt://broker.hivemq.com:1883",              â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   {                                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚     username: process.env.MQTT_USERNAME,         â”‚   â”‚    â”‚
â”‚  â”‚ â”‚     password: process.env.MQTT_PASSWORD,         â”‚   â”‚    â”‚
â”‚  â”‚ â”‚     clientId: "smart-locker-server-12345"        â”‚   â”‚    â”‚
â”‚  â”‚ â”‚   }                                                â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ )                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ On Connection:                                         â”‚    â”‚
â”‚  â”‚ - Subscribe to: device/+/status                       â”‚    â”‚
â”‚  â”‚ - Subscribe to: device/+/heartbeat                    â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ On Message:                                            â”‚    â”‚
â”‚  â”‚ - Handle device status updates                        â”‚    â”‚
â”‚  â”‚ - Update database                                     â”‚    â”‚
â”‚  â”‚ - Broadcast to dashboard                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ MQTT Topics:
             â”œâ”€ device/5/unlock        (Server â†’ Device)
             â”œâ”€ device/5/status        (Device â†’ Server)
             â”œâ”€ device/5/heartbeat     (Device â†’ Server)
             â””â”€ device/5/alert         (Device â†’ Server)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     HiveMQ Cloud MQTT Broker                   â”‚
    â”‚  - Broker URL: mqtt://broker.hivemq.com:1883  â”‚
    â”‚  - Subscription-based message routing          â”‚
    â”‚  - QoS 0, 1, 2 support                         â”‚
    â”‚  - SSL/TLS encryption available                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Wi-Fi (IEEE 802.11)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ESP32-CAM (Firmware - Arduino C++)          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ WiFi.begin("SSID", "PASSWORD")      â”‚    â”‚
    â”‚  â”‚ mqtt.connect(MQTT_BROKER)           â”‚    â”‚
    â”‚  â”‚ mqtt.subscribe("device/5/unlock")   â”‚    â”‚
    â”‚  â”‚                                      â”‚    â”‚
    â”‚  â”‚ if (mqtt.message received):         â”‚    â”‚
    â”‚  â”‚   if (payload.unlock == true):      â”‚    â”‚
    â”‚  â”‚     servo.write(90)  // Open lock   â”‚    â”‚
    â”‚  â”‚     delay(5000)      // Wait 5s     â”‚    â”‚
    â”‚  â”‚     servo.write(0)   // Close lock  â”‚    â”‚
    â”‚  â”‚                                      â”‚    â”‚
    â”‚  â”‚ // Publish status back               â”‚    â”‚
    â”‚  â”‚ mqtt.publish("device/5/status", {  â”‚    â”‚
    â”‚  â”‚   locked: true,                    â”‚    â”‚
    â”‚  â”‚   battery: 85,                     â”‚    â”‚
    â”‚  â”‚   temp: 28.5,                      â”‚    â”‚
    â”‚  â”‚   timestamp: millis()              â”‚    â”‚
    â”‚  â”‚ })                                  â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 6. DATABASE SCHEMA (MySQL)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DATABASE                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ users
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ email (UNIQUE)
              â”‚  â”œâ”€ password_hash (bcrypt)
              â”‚  â”œâ”€ full_name
              â”‚  â”œâ”€ role (enum: 'user', 'admin')
              â”‚  â”œâ”€ created_at
              â”‚  â””â”€ updated_at
              â”‚
              â”œâ”€ devices
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ device_id (UNIQUE, MAC address)
              â”‚  â”œâ”€ device_name
              â”‚  â”œâ”€ location
              â”‚  â”œâ”€ status (enum: 'online', 'offline')
              â”‚  â”œâ”€ battery_level
              â”‚  â”œâ”€ last_seen
              â”‚  â””â”€ created_at
              â”‚
              â”œâ”€ user_device_access
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ user_id (FK â†’ users.id)
              â”‚  â”œâ”€ device_id (FK â†’ devices.id)
              â”‚  â”œâ”€ permission (enum: 'owner', 'shared')
              â”‚  â””â”€ created_at
              â”‚
              â”œâ”€ face_embeddings
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ user_id (FK â†’ users.id)
              â”‚  â”œâ”€ embedding_vector (JSON, 128D vector)
              â”‚  â”œâ”€ confidence
              â”‚  â”œâ”€ registered_at
              â”‚  â””â”€ updated_at
              â”‚
              â”œâ”€ access_logs
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ device_id (FK â†’ devices.id)
              â”‚  â”œâ”€ user_id (FK â†’ users.id, nullable)
              â”‚  â”œâ”€ access_method (enum: 'face', 'remote', 'manual')
              â”‚  â”œâ”€ status (enum: 'success', 'failed', 'unauthorized')
              â”‚  â”œâ”€ face_confidence
              â”‚  â”œâ”€ is_spoofed (boolean)
              â”‚  â”œâ”€ timestamp
              â”‚  â””â”€ created_at
              â”‚
              â”œâ”€ alerts
              â”‚  â”œâ”€ id (PK)
              â”‚  â”œâ”€ device_id (FK â†’ devices.id)
              â”‚  â”œâ”€ alert_type (enum: 'unauthorized_access', 'spoofing_detected', 'device_offline')
              â”‚  â”œâ”€ message
              â”‚  â”œâ”€ image_path (nullable, base64 thumbnail)
              â”‚  â”œâ”€ read_at (nullable)
              â”‚  â”œâ”€ timestamp
              â”‚  â””â”€ created_at
              â”‚
              â””â”€ audit_log
                 â”œâ”€ id (PK)
                 â”œâ”€ action (str)
                 â”œâ”€ actor_id (FK â†’ users.id)
                 â”œâ”€ target (str)
                 â”œâ”€ details (JSON)
                 â””â”€ created_at
\`\`\`

---

## 7. AUTHENTICATION FLOW (JWT)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Credentials   â”‚
â”‚ email + password    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ POST /api/auth/login
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Verification                    â”‚
â”‚ 1. Hash password with bcrypt             â”‚
â”‚ 2. Compare with stored hash              â”‚
â”‚ 3. Generate JWT token if match           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ JWT Token:
           â”‚  Header: { "alg": "HS256", "typ": "JWT" }
           â”‚  Payload: {
           â”‚    "userId": 1,
           â”‚    "email": "user@example.com",
           â”‚    "role": "user",
           â”‚    "iat": 1699000000,
           â”‚    "exp": 1699604800  // 7 days
           â”‚  }
           â”‚  Signature: HMACSHA256(header.payload, JWT_SECRET)
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Storage                         â”‚
â”‚ localStorage.setItem("token", jwt)       â”‚
â”‚ localStorage.setItem("user", userInfo)   â”‚
â”‚ localStorage.setItem("userRole", role)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ Future Requests:
           â”‚  Authorization: Bearer {jwt}
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Verification                    â”‚
â”‚ 1. Extract token from Authorization      â”‚
â”‚ 2. Verify signature                      â”‚
â”‚ 3. Check expiration                      â”‚
â”‚ 4. Proceed if valid                      â”‚
â”‚ 5. Return 401 if invalid/expired         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 8. AI MODELS ARCHITECTURE

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AI Pipeline                                 â”‚
â”‚                                                              â”‚
â”‚  Input: Image from ESP32-CAM (JPEG, 2MP)                   â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Stage 1: Face Detection (MT-CNN)                     â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ P-Net (Proposal Network)                        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Scan image at multiple scales                â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Generate face region proposals               â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Remove low-confidence proposals              â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Output: [100, 50, 300, 400]  (bbox)           â”‚   â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚ â”‚ R-Net (Refine Network)                          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Refine bounding boxes                        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Calculate face landmark offsets              â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Output: Refined bbox, landmarks               â”‚   â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚ â”‚ O-Net (Output Network)                          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Get 5 landmark points (eyes, nose, mouth)   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Face orientation validation                  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Output: Landmarks + confidence                â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  If detected = true â†’ Continue                         â”‚  â”‚
â”‚  â”‚  If detected = false â†’ Return "No face"              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Stage 2: Spoofing Detection (CNN Classifier)         â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ Input: Face crop from Stage 1                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Feature Analysis:                               â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ 1. Skin Texture Analysis                        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Real face: Complex, varied texture        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Printed photo: Uniform, repetitive        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Method: Texture descriptors (LBP)         â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ 2. Lighting & Shadow Analysis                  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Real face: Natural 3D lighting            â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Fake: Flat, inconsistent lighting         â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Method: Frequency domain analysis         â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ 3. Temporal Consistency (if video)             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Real face: Smooth motion                  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Video replay: Jittery, unnatural          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚    - Method: Optical flow analysis             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Output: spoofingRisk (0.0 - 1.0)              â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ If spoofingRisk > 0.7 â†’ ALERT!               â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  If spoofed = true â†’ Return "Spoofing detected"       â”‚  â”‚
â”‚  â”‚  If spoofed = false â†’ Continue                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Stage 3: Face Embedding (FaceNet - 128D Vector)       â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ Input: Face crop (normalized)                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Architecture:                                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ Convolutional Layers (22 layers)        â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ - Extract low-level features (edges)    â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ - Extract mid-level features (shapes)   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ - Extract high-level features (identity)â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚            â†“                                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ Fully Connected Layers                  â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ - Compress features to 128 dimensions   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â”‚ - L2 normalization (unit vector)        â”‚   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚            â†“                                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Output: embedding = [0.234, -0.567, 0.891,   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚         ..., 0.456]  // 128D vector          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                               â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Key Property:                                â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Same person faces â†’ small distance        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - Different people â†’ large distance         â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  Output: 128-dimensional feature vector               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Stage 4: Face Matching (Similarity Comparison)        â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ Input:                                          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - captured_embedding (from Stage 3)           â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - registered_embeddings (from DB)             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ - threshold = 0.6 (similarity)                â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Algorithm: Euclidean Distance + Similarity     â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ for each registered_embedding:                â”‚   â”‚  â”‚
â”‚  â”‚ â”‚   distance = sqrt(sum((c[i] - r[i])^2))      â”‚   â”‚  â”‚
â”‚  â”‚ â”‚   similarity = 1 / (1 + distance)             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Example:                                        â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ captured:    [0.234, -0.567, 0.891, ...]    â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ registered:  [0.245, -0.580, 0.885, ...]    â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ distance = 0.045                              â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ similarity = 0.96 (96%)                       â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Result:                                         â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ if similarity >= threshold:                   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚   MATCH! Return user_id                       â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ else:                                           â”‚   â”‚  â”‚
â”‚  â”‚ â”‚   NO MATCH                                     â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  Output: { match: true/false, similarity: 0.96 }      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Final Decision:                                        â”‚  â”‚
â”‚  â”‚ âœ“ Access Granted â†’ Unlock device                      â”‚  â”‚
â”‚  â”‚ âœ— Access Denied â†’ Send alert                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 9. DEPLOYMENT ARCHITECTURE

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel Deployment                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Frontend (React.js)                                 â”‚    â”‚
â”‚  â”‚ - pages/login, dashboard, admin-dashboard         â”‚    â”‚
â”‚  â”‚ - components/                                       â”‚    â”‚
â”‚  â”‚ - Deployed to CDN (global edge locations)          â”‚    â”‚
â”‚  â”‚ - Auto HTTPS/TLS                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Backend (Node.js API Routes)                        â”‚    â”‚
â”‚  â”‚ - app/api/auth/*                                    â”‚    â”‚
â”‚  â”‚ - app/api/devices/*                                 â”‚    â”‚
â”‚  â”‚ - app/api/face/*                                    â”‚    â”‚
â”‚  â”‚ - Serverless functions (auto-scaling)              â”‚    â”‚
â”‚  â”‚ - Built-in CORS handling                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ External Services                                   â”‚    â”‚
â”‚  â”‚ â”œâ”€ MySQL Database (separate host)                 â”‚    â”‚
â”‚  â”‚ â”œâ”€ HiveMQ Cloud (MQTT Broker)                     â”‚    â”‚
â”‚  â”‚ â””â”€ Optional: Firebase services                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## 10. TÃ“MO Táº®T CÃC GIAO THá»¨C & CHUáº¨N

| Layer | Giao thá»©c | TÃ¡c dá»¥ng |
|-------|----------|---------|
| **Network** | Wi-Fi 802.11 | Káº¿t ná»‘i ESP32-CAM tá»›i router |
| | MQTT (HiveMQ) | ESP32 â†” Server (unlock commands, status) |
| | HTTP/HTTPS | Browser â†” Server (web requests) |
| | WebSocket/SSE | Server â†’ Browser (real-time alerts) |
| **Application** | JWT | XÃ¡c thá»±c ngÆ°á»i dÃ¹ng |
| | TLS/SSL | MÃ£ hÃ³a dá»¯ liá»‡u truyá»n |
| | bcrypt | Hash password an toÃ n |
| **AI** | MT-CNN | PhÃ¡t hiá»‡n khuÃ´n máº·t |
| | FaceNet | TrÃ­ch xuáº¥t embedding khuÃ´n máº·t |
| | CNN Classifier | PhÃ¡t hiá»‡n giáº£ máº¡o |
| | Euclidean Distance | So sÃ¡nh embeddings |
| **Data** | MySQL | LÆ°u trá»¯ dá»¯ liá»‡u |
| | JSON | Äá»‹nh dáº¡ng tin nháº¯n |
| | Base64 | MÃ£ hÃ³a áº£nh trong JSON |

---

Hy vá»ng tÃ i liá»‡u nÃ y giÃºp báº¡n hiá»ƒu rÃµ luá»“ng hoáº¡t Ä‘á»™ng cá»§a há»‡ thá»‘ng!
